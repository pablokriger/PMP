<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PMP - Exam Prep</title>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase SDKs MODULAR (v12.8.0) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth, GoogleAuthProvider, onAuthStateChanged,
  signInWithPopup, signOut
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore, collection, getDocs, query,
  orderBy, addDoc, serverTimestamp, limit
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWctc8V2t30ZX6B88xcfeljfaLfuK8ohM",
  authDomain: "cmp-exam-prep.firebaseapp.com",
  projectId: "cmp-exam-prep",
  storageBucket: "cmp-exam-prep.firebasestorage.app",
  messagingSenderId: "777953288024",
  appId: "1:777953288024:web:13f1413295d3f828340f2d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app), db = getFirestore(app), googleProvider = new GoogleAuthProvider();

// Hacer disponibles para scripts inline (tu código los usa)
Object.assign(window, {
  auth, db, googleProvider, onAuthStateChanged, signInWithPopup, signOut,
  getDocs, collection, query, orderBy, addDoc, serverTimestamp, limit
});
</script>

<style>
:root{
  --bg-1:#E9F2FF;--card:#FFF;--accent:#4D89FF;--primary:#3b82f6;
  --muted:#9aa7bf;--success:#4CAF50;--danger:#F44336
}
*{box-sizing:border-box;font-family:'Lato',sans-serif}
body{margin:0;background:linear-gradient(180deg,var(--bg-1),#F6FBFF);color:#10233b;min-height:100vh;display:flex;flex-direction:column;align-items:center}
.container{width:100%;max-width:980px;padding:15px}
.app-header{display:flex;align-items:center;justify-content:space-between;width:100%;padding:10px 0}
.brand h1{margin:0;font-size:1.25rem;font-weight:700;color:#0f172a}
.brand .lead{margin:4px 0 0;font-size:0.9rem;color:#6b7280;max-width:620px;line-height:1.4}
.header-buttons{display:flex;gap:8px;align-items:center}
.fullscreen-btn,.hambtn,.auth-btn,.lang-btn,.home-header-btn{background:transparent;border:none;cursor:pointer;padding:8px;border-radius:6px}
.auth-btn{background:var(--accent);color:white;font-weight:600;font-size:0.85rem;padding:6px 12px;display:flex;align-items:center;gap:4px}
.user-info{display:flex;align-items:center;gap:6px;background:#f0f4ff;padding:4px 10px;border-radius:6px;font-size:0.8rem;color:#27456e;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.user-info img{border-radius:50%;width:20px;height:20px}

/* Dropdowns, cards, quiz, modals (compacto) */
.menu-dropdown,.lang-menu-list{position:absolute;right:15px;top:54px;background:var(--card);box-shadow:0 10px 30px rgba(20,40,80,0.08);border-radius:8px;padding:6px 0;display:none;min-width:120px;z-index:70}
.menu-dropdown{min-width:240px;overflow:hidden}
.menu-section{padding:12px}
.menu-section.user-section{display:flex;align-items:center;gap:12px;background:#f8fafd;border-bottom:1px solid #f0f4fa}
.menu-section.user-section img{width:36px;height:36px;border-radius:50%}
.menu-section .menu-link{display:block;width:100%;text-align:left;padding:10px 12px;border:none;background:transparent;cursor:pointer;font-size:0.9rem;color:#27456e;border-radius:4px;margin-bottom:2px}
.menu-link:hover{background:#f4f7ff}

.start-card{display:flex;flex-direction:column;gap:8px;align-items:center;background:linear-gradient(90deg,rgba(255,255,255,0.85),rgba(255,255,255,0.6));padding:12px;border-radius:10px;box-shadow:0 8px 20px rgba(79,111,173,0.06);margin-top:10px}
.hero img{width:100%;height:210px;object-fit:cover;border-radius:8px}
.controls{width:100%;display:flex;flex-direction:column;gap:6px}
.controls label{font-weight:700;color:#27456e;font-size:0.95rem}
select,input{padding:6px;border-radius:6px;border:1px solid rgba(39,69,110,0.08)}
.primary{background:var(--accent);color:#fff;border:none;padding:8px;border-radius:8px;cursor:pointer;font-weight:700}
.secondary{background:transparent;border:1px solid rgba(77,137,255,0.18);padding:6px;border-radius:8px;cursor:pointer}
.danger-btn{background:var(--danger);color:#fff;padding:8px;border-radius:8px;border:none}

.quiz-card{display:none;background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(50,70,100,0.06);margin-top:12px;width:100%;position:relative}
.quiz-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.home-btn{background:transparent;border:none;cursor:default;padding:6px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center}
.home-btn.warning svg{animation:blink 1s steps(2) infinite}
@keyframes blink{0%{opacity:1}50%{opacity:0.15}100%{opacity:1}}
.timers{display:flex;gap:10px;align-items:center;color:#27456e;font-weight:700;flex-wrap:wrap}
.time-box{display:flex;flex-direction:column;align-items:center;font-size:0.85rem;min-width:90px;padding:6px;border-radius:6px;background:rgba(255,255,255,0.95);box-shadow:0 3px 8px rgba(0,0,0,0.04);text-align:center}
.time-box small{color:var(--muted);font-weight:600;font-size:0.75rem}
.question{font-size:1rem;margin-bottom:8px;color:#12233b;animation:fadeIn .34s ease}
.options{display:flex;flex-direction:column}
.option-btn{padding:10px;border-radius:8px;border:none;background:#f6f9ff;box-shadow:0 4px 0 rgba(0,0,0,0.06);margin:6px 0;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease,border-radius .12s ease;text-align:left;font-size:0.95rem}
.option-btn.pressed{border-radius:24px;transform:translateY(2px) scale(.99);box-shadow:inset 0 3px 8px rgba(0,0,0,0.06)}
.correct{background:var(--success)!important;color:white!important;box-shadow:none!important}
.wrong{background:var(--danger)!important;color:white!important;box-shadow:none!important}

#explanation{display:none;margin-top:10px;padding:10px;background:#f4f7ff;border-radius:6px;color:#6b7280;font-size:0.85rem;font-style:italic}
.charts-grid{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.chart-card{background:linear-gradient(180deg,#fff,#fbfdff);padding:10px;border-radius:8px;box-shadow:0 6px 16px rgba(15,30,60,0.06);display:flex;flex-direction:column;align-items:center;min-height:180px}
.chart-card canvas{width:100%!important;height:180px!important;display:block}

.modal-backdrop,.timeup-backdrop,.about-backdrop,.pmp-tips-backdrop,.progress-backdrop,.finish-backdrop,.home-exit-backdrop{position:fixed;inset:0;background:rgba(10,20,40,0.35);align-items:center;justify-content:center;z-index:220;display:none}
.modal-backdrop.visible,.timeup-backdrop.visible,.about-backdrop.visible,.pmp-tips-backdrop.visible,.progress-backdrop.visible,.finish-backdrop.visible,.home-exit-backdrop.visible{display:flex}
.modal,.timeup-box,.about-box,.pmp-tips-box,.progress-box,.finish-box,.home-exit-box{background:var(--card);padding:15px;border-radius:8px;box-shadow:0 8px 24px rgba(15,30,60,0.18);width:90%;max-width:500px;text-align:center;max-height:85vh;overflow-y:auto}

.tooltip{position:fixed;background:#22334a;color:#fff;padding:5px 7px;border-radius:5px;font-size:0.8rem;pointer-events:none;opacity:0;transform:translateY(5px);transition:opacity .18s ease,transform .18s ease;z-index:1000}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
@media(max-width:820px){.hero img{height:160px}.container{padding:10px}.version-btn{padding:5px 8px;font-size:0.85rem}.timers{gap:8px}.time-box{min-width:80px;padding:5px;font-size:0.8rem}.nav-btn{min-width:80px}}
@media(max-width:480px){.hero img{height:140px}.start-card{padding:8px}.version-btn{padding:4px 6px;font-size:0.8rem;min-width:70px}.nav-btn{min-width:70px}.time-box{min-width:70px;flex:1}.quiz-toolbar{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
<header class="app-header">
  <div class="brand">
    <h1>Simulador de Examen PMP®</h1>
    <p class="lead">Preparación profesional alineada al PMBOK® 7 — práctica por dominios, examen completo y repaso.</p>
  </div>

  <div style="position:relative">
    <div class="header-buttons">
      <button class="fullscreen-btn" id="fullscreen-btn" aria-label="Pantalla completa" data-tooltip="Pantalla completa">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true" id="fullscreen-icon"><path d="M7 7h4V5H5v6h2V7zm10 0h-4V5h6v6h-2V7zm-10 10v-4H5v6h6v-2H7zm10 0h-4v2h6v-6h-2v4z" fill="#27456e"/></svg>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true" id="exit-fullscreen-icon" style="display:none"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z" fill="#27456e"/></svg>
      </button>

      <button class="lang-btn" id="lang-btn" aria-label="Idioma" data-tooltip="Idioma">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="#27456e" stroke-width="1.2" fill="none"/><path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10A15.3 15.3 0 0112 2z" stroke="#27456e" stroke-width="1.2" fill="none"/></svg>
      </button>

      <button class="home-header-btn" id="home-header-btn" aria-label="Volver al inicio" data-tooltip="Inicio">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke="#27456e" stroke-width="1.2" fill="none"/><path d="M9 22V12h6v10" stroke="#27456e" stroke-width="1.2" fill="none"/></svg>
      </button>

      <div class="top-menu">
        <button id="menuBtn" class="hambtn" aria-label="Menú">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="3" y="5" width="18" height="2" rx="1" fill="#27456e"/><rect x="3" y="11" width="18" height="2" rx="1" fill="#27456e"/><rect x="3" y="17" width="18" height="2" rx="1" fill="#27456e"/></svg>
        </button>

        <div id="menuDropdown" class="menu-dropdown hidden">
          <div class="menu-section user-section">
            <img id="userAvatar" src="https://via.placeholder.com/48" alt="Usuario">
            <div>
              <div id="userName">Invitado</div>
              <button id="loginBtnMenu">Iniciar sesión</button>
              <button id="logoutBtnMenu" class="hidden">Cerrar sesión</button>
            </div>
          </div>
          <hr>
          <div class="menu-section"><button class="menu-link" id="progressMenuBtn">Mi progreso</button></div>
          <hr>
          <div class="menu-section">
            <button class="menu-link" id="consejosMenuBtn">Consejos</button>
            <div id="consejosSubmenu" style="display:none">
              <button class="menu-link tips-option" data-tip-type="consejos_PMP">Certificación PMP</button>
              <button class="menu-link tips-option" data-tip-type="pmbok7_caracteristicas">Sobre el PMBOK7</button>
            </div>
          </div>
          <hr>
          <div class="menu-section about-section"><button class="menu-link" id="aboutMenuBtn">Acerca de</button></div>
        </div>
      </div>
    </div>

    <div class="lang-menu-list" id="lang-menu-list" role="menu" aria-hidden="true">
      <button data-lang="es">Español</button>
      <button data-lang="en">English</button>
    </div>
  </div>
</header>

<!-- Start screen -->
<div id="start-screen">
  <div class="start-card">
    <div class="hero"><img src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?auto=format&fit=crop&w=1200&q=80" alt="Estudio PMP"></div>
    <div class="controls" aria-hidden="false">
      <div>
        <label style="font-weight:800;display:block;margin-bottom:4px;font-size:1rem;">Modalidad:</label>
        <label><input type="radio" name="mode" value="exam" checked> Simulador Examen PMP (180q - 250')</label><br>
        <label><input type="radio" name="mode" value="custom"> Personalizar examen</label>
        <p id="exam-note" style="margin:6px 0 0 0;color:#27456e;font-size:0.85rem;">Se simula un examen real de 180 preguntas en 250 minutos (se incluyen dos posibles descansos de 10 minutos en el total).</p>
      </div>

      <div id="exam-controls" style="margin-top:6px">
        <div class="option-group">
          <label for="version-filter">Versión (solo para Exam PMP):</label><br>
          <div class="version-buttons" id="exam-version-buttons"><button class="version-btn" data-value="v6">v6</button><button class="version-btn selected" data-value="v7">v7</button></div>
          <input type="hidden" id="version-filter-exam" value="v7">
        </div>
      </div>

      <div id="custom-controls" style="margin-top:6px;display:none;border-top:1px dashed rgba(0,0,0,0.04);padding-top:6px">
        <div class="option-group">
          <label style="font-weight:700;">Versión del examen:</label><br>
          <div class="version-buttons" id="custom-version-buttons"><button class="version-btn selected" data-value="both">Ambas</button><button class="version-btn" data-value="v6">v6</button><button class="version-btn" data-value="v7">v7</button></div>
          <input type="hidden" id="custom-version" value="both">
        </div>

        <div class="option-group" style="margin-top:12px">
          <label style="font-weight:700;">Áreas (marcar):</label>
          <div class="areas-actions"><button id="select-all-areas" class="secondary">Seleccionar todo</button><button id="deselect-all-areas" class="secondary">Deseleccionar todo</button></div>
          <div class="areas-container" id="areas-list"></div>
        </div>

        <div class="option-group" style="margin-top:12px">
          <label style="font-weight:700;">Configuración del examen:</label>
          <div style="margin-top:4px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="flex:1;min-width:150px">
              <label for="custom-count">Cantidad de preguntas:</label><br>
              <input id="custom-count" type="number" min="1" max="2000" value="50" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);width:100%;max-width:140px">
              <div style="margin-top:4px"><label><input type="checkbox" id="custom-all-questions"> Todas</label></div>
            </div>

            <div style="flex:1;min-width:150px">
              <label for="custom-time">Tiempo total (minutos):</label><br>
              <input id="custom-time" type="number" min="1" value="60" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);width:100%;max-width:140px">
              <div style="margin-top:4px"><label><input type="checkbox" id="custom-no-time"> Sin límite de tiempo</label></div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap">
        <button class="primary" id="start-btn" data-tooltip="Comenzar" style="flex:1;min-width:120px">Comenzar Quiz</button>
        <button class="secondary" id="about-btn" data-tooltip="Acerca de" style="flex:1;min-width:120px">Acerca de</button>
      </div>
    </div>
  </div>
</div>

<div class="score" id="score-container" style="display:none">Puntaje: <span id="score">0</span> | Pregunta: <span id="current-question">0</span>/<span id="total-questions">0</span></div>

<div class="quiz-card" id="quiz-container" aria-live="polite">
  <div class="quiz-toolbar">
    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
      <button class="home-btn" id="home-button" title="Reloj (sin acción)" data-tooltip="Reloj" aria-label="Reloj de examen">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="#27456e" stroke-width="1.2"/><path d="M12 7v6l4 2" stroke="#27456e" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>

      <div class="timers">
        <div class="time-box"><small>Initial total</small><div id="initial-total">0m</div></div>
        <div class="time-box"><small>Remaining</small><div id="total-timer">0m 0s</div></div>
        <div class="time-box"><small>Question elapsed</small><div id="question-timer">0m 0s</div></div>
      </div>
    </div>

    <div style="color:#27456e;font-weight:700;display:flex;align-items:center;gap:6px;flex-wrap:wrap">
      <span id="progress-display"></span>
      <button id="finish-btn" class="secondary" style="padding:6px 8px;border-radius:6px;font-weight:700" data-tooltip="Finalizar">Finalizar cuestionario</button>
    </div>
  </div>

  <div class="question" id="question"></div>
  <div class="info" id="q-info"></div>
  <div class="options" id="options" role="list"></div>

  <div class="nav-buttons">
    <button id="prev-btn" class="nav-btn" aria-label="Anterior" data-tooltip="Retroceder"><svg viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    <button id="next-btn" class="nav-btn" aria-label="Siguiente" data-tooltip="Avanzar"><svg viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
  </div>

  <div id="explanation" aria-live="polite"></div>
  <div id="question-area"></div>
</div>

<div class="end-screen" id="end-screen">
  <div class="end-actions">
    <button id="restart-btn" class="icon-btn" title="Reiniciar quiz" data-tooltip="Reiniciar quiz" aria-label="Reiniciar quiz">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 4v5h-5" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 12a8 8 0 0 1 8-8 8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8z" stroke="#fff" stroke-width="2.5" fill="none"/></svg>
    </button>
  </div>

  <h3 class="results-title">Resultados y estadísticas</h3>
  <div class="results-group" id="result-general" style="display:none"><h4>Performance</h4><div class="performance-summary" id="performance-summary"></div></div>
  <div class="results-group" id="group-charts" style="display:none"><h4>Gráficos</h4><div class="charts-grid" id="charts-grid"><div class="chart-card"><h4>Desempeño general</h4><canvas id="pieChart"></canvas></div><div class="chart-card"><h4>Exactitud por área</h4><canvas id="barChart"></canvas></div></div></div>
  <div class="results-group" id="group-performance" style="display:none"><h4>Estadísticas del intento</h4><div class="stats-box" id="final-stats" style="display:none"></div></div>
  <div class="results-group" id="group-history" style="display:none"><h4>Historial</h4><div class="history" id="history-list"></div></div>
  <div class="results-group" id="user-history-section" style="display:none"><h4>Tu Historial Personal</h4><div id="user-history-list" class="history"><p>Inicia sesión para ver tu historial personalizado</p></div></div>
</div>

<footer>© Pablo Kriger 2026 (Todos los Derechos Reservados)</footer>
</div>

<!-- Modals -->
<div class="modal-backdrop" id="exit-backdrop" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true" aria-labelledby="exit-title"><h3 id="exit-title">¿Desea salir?</h3><p>Se borrará el avance actual del quiz. ¿Desea continuar?</p><div class="actions" style="display:flex;gap:12px;justify-content:center;margin-top:16px"><button id="exit-no" class="secondary" style="min-width:100px">NO</button><button id="exit-yes" class="danger-btn" style="min-width:100px">SI</button></div></div></div>

<div class="home-exit-backdrop" id="home-exit-backdrop" aria-hidden="true"><div class="home-exit-box" role="dialog" aria-modal="true" aria-labelledby="home-exit-title"><h3 id="home-exit-title">¿Desea salir?</h3><p>Se borrará el avance actual del quiz. ¿Desea continuar?</p><div class="actions" style="display:flex;gap:12px;justify-content:center;margin-top:16px"><button id="home-exit-no" class="secondary" style="min-width:100px">NO</button><button id="home-exit-yes" class="danger-btn" style="min-width:100px">SI</button></div></div></div>

<div class="about-backdrop" id="about-backdrop" aria-hidden="true"><div class="about-card" role="dialog" aria-modal="true" aria-labelledby="about-title"><h3 id="about-title">Acerca de</h3><div class="about-body"><div class="about-main"><div class="app-title">PMP — Exam Prep</div><div class="app-meta">Versión 1.3</div><div class="copyright">© Pablo Kriger 2026. All rights reserved.</div></div><p class="disclaimer">Disclaimer: PMP® y PMBOK® son marcas registradas del Project Management Institute, Inc. Este simulador no está afiliado ni avalado por el PMI.</p></div><div style="margin-top:16px; text-align:center;"><button id="about-close" class="primary" style="min-width:100px">Cerrar</button></div></div></div>

<div class="pmp-tips-backdrop" id="pmp-tips-backdrop" aria-hidden="true"><div class="pmp-tips-box" role="dialog" aria-modal="true" aria-labelledby="pmp-tips-title"><h3 id="pmp-tips-title">Consejos PMP</h3><div class="pmp-tabs"><button class="pmp-tab active" data-tab="consejos_PMP">Certificación PMP</button><button class="pmp-tab" data-tab="pmbok7_caracteristicas">Sobre el PMBOK7</button></div><div class="pmp-content" id="pmp-content">Selecciona una categoría para ver contenido</div><div class="pmp-actions"><button id="pmp-another" class="secondary">Otro consejo</button><button id="pmp-close" class="primary">Cerrar</button></div></div></div>

<div class="progress-backdrop" id="progress-backdrop" aria-hidden="true"><div class="progress-box" role="dialog" aria-modal="true" aria-labelledby="progress-title"><h3 id="progress-title">Mi Progreso</h3><div class="progress-content"><p>Aquí puedes ver tu progreso en el entrenamiento PMP:</p><div class="progress-stats"><h4>Estadísticas Generales</h4><p><strong>Total de quizzes completados:</strong> <span id="total-quizzes">0</span></p><p><strong>Promedio de puntaje:</strong> <span id="avg-score">0%</span></p><p><strong>Mejor puntaje:</strong> <span id="best-score">0%</span></p><p><strong>Tiempo total de estudio:</strong> <span id="total-study-time">0h 0m</span></p></div><div class="progress-stats"><h4>Progreso por Áreas</h4><p><strong>Áreas dominadas:</strong> <span id="mastered-areas">0</span></p><p><strong>Áreas por mejorar:</strong> <span id="improve-areas">0</span></p></div></div><div class="pmp-actions"><button id="progress-close" class="primary">Cerrar</button></div></div></div>

<div class="finish-backdrop" id="finish-backdrop" aria-hidden="true"><div class="finish-box" role="dialog" aria-modal="true" aria-labelledby="finish-title"><h3 id="finish-title">¿Está seguro de que desea finalizar el cuestionario?</h3><div class="actions" style="display:flex;gap:12px;justify-content:center;margin-top:16px"><button id="finish-no" class="secondary" style="min-width:100px">NO</button><button id="finish-yes" class="danger-btn" style="min-width:100px">SI</button></div></div></div>

<div class="timeup-backdrop" id="timeup-backdrop" aria-hidden="true"><div class="timeup-box"><h4>Tiempo finalizado</h4><p>El tiempo del examen ha finalizado. Presione Aceptar para ver las estadísticas.</p><div style="display:flex;justify-content:center;margin-top:12px"><button id="timeup-accept" class="primary">Aceptar</button></div></div></div>

<div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

<script>
/* ==========================
   Variables globales y referencias DOM (conservadas)
   ========================== */
let allQuestions = [];
let tipsData = { consejos_PMP: [], pmbok7_caracteristicas: [] };
let currentTipsIndex = -1, currentPmbok7Index = -1;
let questions = [], current = 0, score = 0, history = {}, totalTimerSeconds = 0, initialTotalSeconds = 0;
let examTimerInterval = null, questionElapsedSeconds = 0, questionTimerInterval = null, answered = false;
let noTimeLimit = false, sessionElapsedSeconds = 0, sessionElapsedInterval = null, pieChart = null, barChart = null, isFullscreen = false;

const loginBtnMenu = document.getElementById('loginBtnMenu'),
  logoutBtnMenu = document.getElementById('logoutBtnMenu'),
  userAvatar = document.getElementById('userAvatar'),
  userName = document.getElementById('userName'),
  userHistorySection = document.getElementById('user-history-section'),
  userHistoryList = document.getElementById('user-history-list'),
  langBtn = document.getElementById('lang-btn'),
  langMenuList = document.getElementById('lang-menu-list'),
  questionAreaEl = document.getElementById('question-area'),
  finishBackdrop = document.getElementById('finish-backdrop'),
  finishYes = document.getElementById('finish-yes'),
  finishNo = document.getElementById('finish-no'),
  menuBtn = document.getElementById('menuBtn'),
  menuDropdown = document.getElementById('menuDropdown'),
  progressMenuBtn = document.getElementById('progressMenuBtn'),
  aboutMenuBtn = document.getElementById('aboutMenuBtn'),
  consejosMenuBtn = document.getElementById('consejosMenuBtn'),
  consejosSubmenu = document.getElementById('consejosSubmenu'),
  pmpTipsBackdrop = document.getElementById('pmp-tips-backdrop'),
  pmpContent = document.getElementById('pmp-content'),
  pmpAnotherBtn = document.getElementById('pmp-another'),
  pmpCloseBtn = document.getElementById('pmp-close'),
  pmpTabs = document.querySelectorAll('.pmp-tab'),
  progressBackdrop = document.getElementById('progress-backdrop'),
  progressCloseBtn = document.getElementById('progress-close'),
  homeHeaderBtn = document.getElementById('home-header-btn'),
  homeExitBackdrop = document.getElementById('home-exit-backdrop'),
  homeExitNo = document.getElementById('home-exit-no'),
  homeExitYes = document.getElementById('home-exit-yes'),
  fullscreenBtn = document.getElementById('fullscreen-btn'),
  aboutBackdrop = document.getElementById('about-backdrop'),
  aboutCloseBtn = document.getElementById('about-close');

const versionSelectExam=document.getElementById('version-filter-exam'),
  startBtn=document.getElementById('start-btn'),
  aboutBtn=document.getElementById('about-btn'),
  startScreen=document.getElementById('start-screen'),
  quizContainer=document.getElementById('quiz-container'),
  endScreen=document.getElementById('end-screen'),
  scoreContainer=document.getElementById('score-container'),
  questionEl=document.getElementById('question'),
  qInfoEl=document.getElementById('q-info'),
  optionsEl=document.getElementById('options'),
  explanationEl=document.getElementById('explanation'),
  nextBtn=document.getElementById('next-btn'),
  prevBtn=document.getElementById('prev-btn'),
  restartBtn=document.getElementById('restart-btn'),
  homeBtn=document.getElementById('home-button'),
  exitBackdrop=document.getElementById('exit-backdrop'),
  exitYes=document.getElementById('exit-yes'),
  exitNo=document.getElementById('exit-no'),
  totalTimerEl=document.getElementById('total-timer'),
  initialTotalEl=document.getElementById('initial-total'),
  questionTimerEl=document.getElementById('question-timer'),
  progressDisplay=document.getElementById('progress-display'),
  finishBtn=document.getElementById('finish-btn'),
  timeupBackdrop=document.getElementById('timeup-backdrop'),
  timeupAccept=document.getElementById('timeup-accept'),
  chartsGrid=document.getElementById('charts-grid'),
  tooltipEl=document.getElementById('tooltip'),
  areasListEl=document.getElementById('areas-list'),
  selectAllAreasBtn=document.getElementById('select-all-areas'),
  deselectAllAreasBtn=document.getElementById('deselect-all-areas'),
  customCountInput=document.getElementById('custom-count'),
  customTimeInput=document.getElementById('custom-time'),
  customAllQuestions=document.getElementById('custom-all-questions'),
  customNoTime=document.getElementById('custom-no-time'),
  groupChartsEl=document.getElementById('group-charts'),
  groupPerformanceEl=document.getElementById('group-performance'),
  groupHistoryEl=document.getElementById('group-history'),
  finalStatsEl=document.getElementById('final-stats'),
  performanceSummaryEl=document.getElementById('performance-summary'),
  historyListEl=document.getElementById('history-list'),
  resultGeneralEl=document.getElementById('result-general'),
  examVersionButtons=document.getElementById('exam-version-buttons'),
  customVersionButtons=document.getElementById('custom-version-buttons');

/* ==========================
   Helpers: backdrops, fullscreen, menu, tooltips
   ========================== */
function showBackdrop(id){ const el=document.getElementById(id); if(el){ el.classList.add('visible'); el.style.display='flex'; el.setAttribute('aria-hidden','false'); } }
function hideBackdrop(id){ const el=document.getElementById(id); if(el){ el.classList.remove('visible'); el.style.display='none'; el.setAttribute('aria-hidden','true'); } }

function toggleFullscreen(){
  if(!isFullscreen){
    const el=document.documentElement;
    if(el.requestFullscreen) el.requestFullscreen();
    else if(el.mozRequestFullScreen) el.mozRequestFullScreen();
    else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if(el.msRequestFullscreen) el.msRequestFullscreen();
  } else {
    if(document.exitFullscreen) document.exitFullscreen();
    else if(document.mozCancelFullScreen) document.mozCancelFullScreen();
    else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
    else if(document.msExitFullscreen) document.msExitFullscreen();
  }
}
function updateFullscreenButton(){
  const fs=document.getElementById('fullscreen-icon'), xfs=document.getElementById('exit-fullscreen-icon');
  if(isFullscreen){ if(fs) fs.style.display='none'; if(xfs) xfs.style.display='block'; fullscreenBtn.setAttribute('data-tooltip','Salir de pantalla completa'); fullscreenBtn.setAttribute('aria-label','Salir de pantalla completa'); }
  else { if(fs) fs.style.display='block'; if(xfs) xfs.style.display='none'; fullscreenBtn.setAttribute('data-tooltip','Pantalla completa'); fullscreenBtn.setAttribute('aria-label','Pantalla completa'); }
}
function handleFullscreenChange(){ isFullscreen = !!(document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement); updateFullscreenButton(); }
['fullscreenchange','mozfullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(ev=>document.addEventListener(ev, handleFullscreenChange));
fullscreenBtn?.addEventListener('click', toggleFullscreen);

/* Dropdown menu */
let isMenuOpen=false;
menuBtn?.addEventListener('click', e=>{ e.stopPropagation(); isMenuOpen=!isMenuOpen; menuDropdown.style.display = isMenuOpen ? 'block' : 'none'; langMenuList.style.display='none'; langMenuList.setAttribute('aria-hidden','true'); if(!isMenuOpen) consejosSubmenu.style.display='none';});
document.addEventListener('click', e=>{ if(!menuDropdown.contains(e.target) && e.target !== menuBtn){ menuDropdown.style.display='none'; isMenuOpen=false; consejosSubmenu.style.display='none'; } });

/* Language menu */
langBtn?.addEventListener('click', e=>{ e.stopPropagation(); const isVisible = langMenuList.style.display === 'block'; langMenuList.style.display = isVisible ? 'none' : 'block'; langMenuList.setAttribute('aria-hidden', isVisible ? 'true' : 'false'); menuDropdown.style.display='none'; isMenuOpen=false; consejosSubmenu.style.display='none';});
document.addEventListener('click', e=>{ if(!langMenuList.contains(e.target) && e.target !== langBtn){ langMenuList.style.display='none'; langMenuList.setAttribute('aria-hidden','true'); } });

/* Tooltips (simple) */
let tooltipTimer=null;
document.body.addEventListener('mouseover', (e)=>{ const t=e.target.closest('[data-tooltip]'); if(!t) return; const text=t.getAttribute('data-tooltip'); clearTimeout(tooltipTimer); tooltipTimer=setTimeout(()=>{ tooltipEl.textContent=text; tooltipEl.style.display='block'; const rect=t.getBoundingClientRect(); const left=Math.max(8,rect.left+rect.width/2-60); tooltipEl.style.left=left+'px'; tooltipEl.style.top=(rect.top-40)+'px'; tooltipEl.style.opacity='1'; tooltipEl.setAttribute('aria-hidden','false'); }, 500); });
document.body.addEventListener('mouseout', (e)=>{ const t=e.target.closest('[data-tooltip]'); if(!t) return; clearTimeout(tooltipTimer); tooltipEl.style.opacity='0'; tooltipEl.setAttribute('aria-hidden','true'); setTimeout(()=>{ if(tooltipEl.style.opacity==='0'){ tooltipEl.style.display='none'; tooltipEl.textContent=''; } }, 200); });

/* Close modal by clicking outside */
function setupModalCloseOnClickOutside(id){ const b=document.getElementById(id); if(!b) return; b.addEventListener('click', e=>{ if(e.target===b) hideBackdrop(id); }); }
['about-backdrop','pmp-tips-backdrop','progress-backdrop','finish-backdrop','home-exit-backdrop','exit-backdrop','timeup-backdrop'].forEach(setupModalCloseOnClickOutside);

/* ==========================
   Autenticación (Firebase Auth)
   ========================== */
function initAuth(){
  onAuthStateChanged(auth, (user) => {
    if (user) {
      loginBtnMenu.style.display = 'none';
      logoutBtnMenu.style.display = 'block';
      logoutBtnMenu.classList.remove('hidden');
      userAvatar.src = user.photoURL || 'https://via.placeholder.com/48';
      userName.textContent = user.displayName || user.email || 'Usuario';
      userHistorySection.style.display = 'block';
      userHistoryList.innerHTML = '<p>Cargando tu historial...</p>';
      loadUserHistory(user.uid);
      loadProgressData(user.uid);
    } else {
      loginBtnMenu.style.display = 'block';
      logoutBtnMenu.style.display = 'none';
      logoutBtnMenu.classList.add('hidden');
      userAvatar.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzlhYTdiZiI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==';
      userName.textContent = 'Invitado';
      userHistorySection.style.display = 'none';
    }
  });

  loginBtnMenu?.addEventListener('click', () => {
    signInWithPopup(auth, googleProvider)
      .then(() => { menuDropdown.style.display='none'; isMenuOpen=false; })
      .catch((error) => { alert('Error al iniciar sesión: ' + (error.message||error)); });
  });

  logoutBtnMenu?.addEventListener('click', () => {
    signOut(auth).then(()=>{ menuDropdown.style.display='none'; isMenuOpen=false; }).catch(console.error);
  });
}

/* ==========================
   Firestore: cargar preguntas, historial y progreso
   ========================== */
async function cargarPreguntas(){
  const q = query(collection(db, "questions"), orderBy("number"));
  const snapshot = await getDocs(q);
  const preguntas = [];
  snapshot.forEach(doc => preguntas.push(doc.data()));
  return preguntas;
}

function loadUserHistory(userId){
  const userHistoryRef = collection(db, 'users', userId, 'history');
  const q = query(userHistoryRef, orderBy('timestamp', 'desc'), limit(5));
  getDocs(q).then((querySnapshot) => {
    if (querySnapshot.empty) { userHistoryList.innerHTML = '<p>Aún no tienes historial. ¡Completa tu primer quiz!</p>'; return; }
    let html = '';
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const date = data.timestamp ? data.timestamp.toDate() : new Date();
      html += `<p>${date.toLocaleDateString()} - ${data.score || 0}% - ${data.totalQuestions || 0} preguntas</p>`;
    });
    userHistoryList.innerHTML = html;
  }).catch((error)=>{ userHistoryList.innerHTML = '<p>Error cargando historial</p>'; console.error(error); });
}

function loadProgressData(userId){
  const userHistoryRef = collection(db, 'users', userId, 'history');
  getDocs(userHistoryRef).then((querySnapshot)=>{
    if (querySnapshot.empty) {
      document.getElementById('total-quizzes').textContent = '0';
      document.getElementById('avg-score').textContent = '0%';
      document.getElementById('best-score').textContent = '0%';
      document.getElementById('total-study-time').textContent = '0h 0m';
      document.getElementById('mastered-areas').textContent = '0';
      document.getElementById('improve-areas').textContent = '0';
      return;
    }
    let totalQuizzes=0,totalScore=0,bestScore=0,totalTime=0,areasStats={};
    querySnapshot.forEach(doc => {
      const data = doc.data();
      totalQuizzes++; totalScore += data.score || 0; bestScore = Math.max(bestScore, data.score || 0); totalTime += data.timeSpent || 0;
      if (data.areas) Object.keys(data.areas).forEach(area => {
        if (!areasStats[area]) areasStats[area] = { correct:0, total:0 };
        areasStats[area].correct += data.areas[area].correct || 0;
        areasStats[area].total += data.areas[area].total || 0;
      });
    });
    const avgScore = totalQuizzes > 0 ? Math.round(totalScore / totalQuizzes) : 0;
    const totalHours = Math.floor(totalTime / 3600), totalMinutes = Math.floor((totalTime % 3600) / 60);
    let masteredAreas=0,improveAreas=0;
    Object.keys(areasStats).forEach(area => { const percentage = areasStats[area].total ? Math.round((areasStats[area].correct/areasStats[area].total)*100) : 0; if (percentage>=70) masteredAreas++; else improveAreas++; });
    document.getElementById('total-quizzes').textContent = totalQuizzes;
    document.getElementById('avg-score').textContent = avgScore + '%';
    document.getElementById('best-score').textContent = bestScore + '%';
    document.getElementById('total-study-time').textContent = totalHours + 'h ' + totalMinutes + 'm';
    document.getElementById('mastered-areas').textContent = masteredAreas;
    document.getElementById('improve-areas').textContent = improveAreas;
  }).catch(console.error);
}

function saveQuizResults(userId, results){
  const historyRef = collection(db, 'users', userId, 'history');
  return addDoc(historyRef, {
    timestamp: serverTimestamp(),
    score: results.percent,
    totalQuestions: results.total,
    correct: results.correct,
    timeSpent: results.timeSpent,
    areas: results.areas || {}
  });
}

/* ==========================
   Tips (fetch JSON) and UI for tips
   ========================== */
async function loadTipsData(){
  try {
    const response = await fetch('https://raw.githubusercontent.com/pablokriger/PMP/main/data_cmp.json');
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    tipsData = await response.json();
  } catch (error) {
    tipsData = { consejos_PMP: ['Error cargando consejos de rendimiento PMP'], pmbok7_caracteristicas: ['Error cargando información PMBOK7'] };
    console.error('Error cargando consejos:', error);
  }
}

function showRandomTip(category){
  const contentEl = document.getElementById('pmp-content');
  if (category === 'consejos_PMP') {
    if (!tipsData.consejos_PMP?.length) { contentEl.textContent = 'Cargando consejos de rendimiento PMP...'; return; }
    let newIndex; do { newIndex = Math.floor(Math.random()*tipsData.consejos_PMP.length); } while (newIndex===currentTipsIndex && tipsData.consejos_PMP.length>1);
    currentTipsIndex=newIndex; contentEl.textContent = tipsData.consejos_PMP[currentTipsIndex];
  } else if (category === 'pmbok7_caracteristicas') {
    if (!tipsData.pmbok7_caracteristicas?.length) { contentEl.textContent = 'Cargando información de PMBOK7...'; return; }
    let newIndex; do { newIndex = Math.floor(Math.random()*tipsData.pmbok7_caracteristicas.length); } while (newIndex===currentPmbok7Index && tipsData.pmbok7_caracteristicas.length>1);
    currentPmbok7Index=newIndex; contentEl.textContent = tipsData.pmbok7_caracteristicas[currentPmbok7Index];
  } else contentEl.textContent = 'Selecciona una categoría para ver contenido';
}

/* Tips UI handlers */
consejosMenuBtn?.addEventListener('click', ()=>{ const is = consejosSubmenu.style.display === 'block'; consejosSubmenu.style.display = is ? 'none' : 'block'; });
document.querySelectorAll('.tips-option').forEach(btn => btn.addEventListener('click', (e)=>{ const tipType = e.target.dataset.tipType; showBackdrop('pmp-tips-backdrop'); pmpTabs.forEach(tab => tab.dataset.tab===tipType ? tab.classList.add('active') : tab.classList.remove('active')); showRandomTip(tipType); menuDropdown.style.display='none'; isMenuOpen=false; consejosSubmenu.style.display='none'; }));
pmpAnotherBtn?.addEventListener('click', ()=>{ const activeTab = document.querySelector('.pmp-tab.active'); if(activeTab) showRandomTip(activeTab.dataset.tab); });
pmpCloseBtn?.addEventListener('click', ()=> hideBackdrop('pmp-tips-backdrop'));
pmpTabs.forEach(tab => tab.addEventListener('click', ()=>{ pmpTabs.forEach(t=>t.classList.remove('active')); tab.classList.add('active'); showRandomTip(tab.dataset.tab); }));

/* ==========================
   UI: areas, version buttons, start/custom controls
   ========================== */
function populateAreas(){
  if(allQuestions.length===0){ areasListEl.innerHTML='<div style="color:#9aa7bf;text-align:center;padding:10px;">Cargando áreas...</div>'; return; }
  const areas = Array.from(new Set(allQuestions.map(q => q.area))).sort();
  areasListEl.innerHTML = '';
  areas.forEach(a => { const id = 'area_'+a.replace(/\s+/g,'_'); const wrapper = document.createElement('label'); wrapper.innerHTML = `<input type="checkbox" value="${a}" id="${id}" checked> <span>${a}</span>`; areasListEl.appendChild(wrapper); });
}

function setupVersionButtons(container,hiddenInputId){
  const buttons = container.querySelectorAll('.version-btn');
  const hiddenInput = document.getElementById(hiddenInputId);
  buttons.forEach(btn => btn.addEventListener('click', ()=>{
    buttons.forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    if(hiddenInput) hiddenInput.value = btn.dataset.value;
  }));
  const sel = container.querySelector('.version-btn.selected');
  if(sel && hiddenInput) hiddenInput.value = sel.dataset.value;
}

selectAllAreasBtn?.addEventListener('click', ()=> Array.from(areasListEl.querySelectorAll('input[type=checkbox]')).forEach(c=>c.checked=true));
deselectAllAreasBtn?.addEventListener('click', ()=> Array.from(areasListEl.querySelectorAll('input[type=checkbox]')).forEach(c=>c.checked=false));

const modeRadios = Array.from(document.querySelectorAll('input[name="mode"]'));
modeRadios.forEach(r => r.addEventListener('change', onModeChange));
function onModeChange(){ const mode=document.querySelector('input[name="mode"]:checked').value; document.getElementById('exam-controls').style.display = mode==='exam' ? 'block' : 'none'; document.getElementById('custom-controls').style.display = mode==='custom' ? 'block' : 'none'; document.getElementById('exam-note').style.display = mode==='exam' ? 'block' : 'none'; }

if(customAllQuestions) customAllQuestions.addEventListener('change', ()=> customCountInput.disabled = customAllQuestions.checked);
if(customNoTime) customNoTime.addEventListener('change', ()=> customTimeInput.disabled = customNoTime.checked);

/* ==========================
   Quiz core: start, timers, showQuestion, answer handling, finish
   ========================== */
startBtn?.addEventListener('click', ()=>{ if(allQuestions.length===0){ alert('Los datos aún no se han cargado. Por favor, espera un momento.'); return; } startQuiz(); });
aboutBtn?.addEventListener('click', ()=> showBackdrop('about-backdrop'));
finishBtn?.addEventListener('click', ()=> showBackdrop('finish-backdrop'));
finishNo?.addEventListener('click', ()=> hideBackdrop('finish-backdrop'));
finishYes?.addEventListener('click', ()=> { hideBackdrop('finish-backdrop'); finishQuiz(); });

function startQuiz(){
  const mode = document.querySelector('input[name="mode"]:checked').value;
  questions = []; current = 0; score = 0; history = {}; answered = false; noTimeLimit = false; clearAllIntervals();
  sessionElapsedSeconds = 0; sessionElapsedInterval = setInterval(()=> sessionElapsedSeconds++, 1000);

  if(mode === 'exam'){
    const version = document.getElementById('version-filter-exam').value;
    if(!version){ alert('Selecciona la versión (v6 o v7) para Exam PMP.'); return; }
    let pool = allQuestions.filter(q => q.version === version);
    pool = shuffleArray(pool);
    const desired = 180;
    if(pool.length === 0){ alert(`No hay preguntas para la versión ${version}.`); return; }
    if(pool.length < desired && !confirm(`Solo hay ${pool.length} preguntas disponibles en ${version}. Se usará ese total.`)) return;
    questions = pool.slice(0, Math.min(desired, pool.length));
    initialTotalSeconds = 250*60; totalTimerSeconds = initialTotalSeconds; noTimeLimit = false;
  } else {
    const checkedAreas = Array.from(areasListEl.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
    let pool = allQuestions.filter(q => checkedAreas.length===0 ? true : checkedAreas.includes(q.area));
    const verChoice = document.getElementById('custom-version').value;
    if(verChoice && verChoice !== 'both') pool = pool.filter(q => q.version === verChoice);
    if(pool.length === 0){ alert('No hay preguntas para las áreas/versión seleccionadas.'); return; }
    pool = shuffleArray(pool);
    let count;
    if(customAllQuestions && customAllQuestions.checked) count = pool.length;
    else { count = parseInt(customCountInput.value||'0',10); if(isNaN(count)||count<=0){ alert('Cantidad inválida de preguntas'); return; } }
    if(pool.length < count && !confirm(`Solo hay ${pool.length} preguntas disponibles. Se usará ese total.`)) return;
    questions = pool.slice(0, Math.min(count, pool.length));
    if(customNoTime && customNoTime.checked){ noTimeLimit = true; initialTotalSeconds=0; totalTimerSeconds=0; } else { noTimeLimit = false; initialTotalSeconds = parseInt(customTimeInput.value||'0',10)*60; totalTimerSeconds = initialTotalSeconds; }
  }

  document.getElementById('score').innerText = score;
  document.getElementById('current-question').innerText = current+1;
  document.getElementById('total-questions').innerText = questions.length;
  initialTotalEl.textContent = noTimeLimit ? 'Sin límite' : formatTime(initialTotalSeconds);
  startScreen.style.display = 'none'; quizContainer.style.display = 'block'; endScreen.style.display = 'none'; scoreContainer.style.display = 'block';
  if(!noTimeLimit && initialTotalSeconds>0) startTotalTimer(); else { totalTimerEl.textContent='Sin límite'; homeBtn.classList.remove('warning'); }
  showQuestion();
}

function clearAllIntervals(){ clearInterval(examTimerInterval); clearInterval(questionTimerInterval); clearInterval(sessionElapsedInterval); examTimerInterval = questionTimerInterval = sessionElapsedInterval = null; }

function startTotalTimer(){
  clearInterval(examTimerInterval);
  totalTimerEl.textContent = formatTime(totalTimerSeconds);
  examTimerInterval = setInterval(()=>{
    if(totalTimerSeconds>0){
      totalTimerSeconds--; totalTimerEl.textContent = formatTime(totalTimerSeconds);
      if(totalTimerSeconds <= 60) homeBtn.classList.add('warning'); else homeBtn.classList.remove('warning');
      if(totalTimerSeconds <= 0){ clearInterval(examTimerInterval); homeBtn.classList.remove('warning'); showBackdrop('timeup-backdrop'); }
    } else clearInterval(examTimerInterval);
  },1000);
}

function startQuestionTimer(){
  clearInterval(questionTimerInterval);
  questionElapsedSeconds = 0; questionTimerEl.textContent = formatElapsed(questionElapsedSeconds);
  questionTimerInterval = setInterval(()=>{ questionElapsedSeconds++; questionTimerEl.textContent = formatElapsed(questionElapsedSeconds); }, 1000);
}

function showQuestion(){
  answered = false;
  const q = questions[current];
  if(!q){ finishQuiz(); return; }
  questionEl.textContent = `${current+1}. ${q.question}`;
  qInfoEl.textContent = `Versión: ${q.version||'N/A'}`;
  questionAreaEl.textContent = `Área: ${q.area||'N/A'}`; questionAreaEl.style.display='block';
  progressDisplay.textContent = `Pregunta ${current+1} de ${questions.length}`;
  if(current === questions.length - 1){ nextBtn.innerHTML = 'Finalizar cuestionario'; nextBtn.classList.add('finalize'); }
  else { nextBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'; nextBtn.classList.remove('finalize'); }

  optionsEl.innerHTML = '';
  let shuffledOrder = [];
  const hist = history[q.number];
  if(hist && hist.shuffledOrder) shuffledOrder = hist.shuffledOrder;
  else { shuffledOrder = shuffleArray(Array.from({length:q.options.length},(_,i)=>i)); history[q.number] = history[q.number] || {}; history[q.number].shuffledOrder = shuffledOrder; }

  for(let pos=0; pos<shuffledOrder.length; pos++){
    const origIdx = shuffledOrder[pos];
    const btn = document.createElement('button');
    btn.type='button'; btn.className='option-btn'; btn.textContent = q.options[origIdx]||''; btn.dataset.pos = pos;
    btn.addEventListener('pointerdown', (ev)=>{ ev.preventDefault(); btn.classList.add('pressed'); try{ btn.setPointerCapture(ev.pointerId); }catch(e){} });
    btn.addEventListener('pointerup', (ev)=>{ ev.preventDefault(); try{ btn.releasePointerCapture(ev.pointerId); }catch(e){} const rect=btn.getBoundingClientRect(); const inside = ev.clientX>=rect.left && ev.clientX<=rect.right && ev.clientY>=rect.top && ev.clientY<=rect.bottom; btn.classList.remove('pressed'); if(!inside || answered) return; const prev = history[q.number]; if(prev && typeof prev.selected === 'number') return; const selectedPos = parseInt(btn.dataset.pos,10); Array.from(optionsEl.children).forEach(b=>b.classList.remove('selected')); btn.classList.add('selected'); handleAnswer(selectedPos, shuffledOrder); });
    btn.addEventListener('pointerleave', ()=> btn.classList.remove('pressed'));
    optionsEl.appendChild(btn);
  }

  if(hist && typeof hist.selected !== 'undefined'){
    const buttons = Array.from(optionsEl.children);
    for(let i=0;i<buttons.length;i++){
      const realIdx = shuffledOrder[i];
      buttons[i].disabled = true;
      if(realIdx === q.correct) buttons[i].classList.add('correct');
      if(hist.selected === realIdx && hist.selected !== q.correct) buttons[i].classList.add('wrong');
      if(hist.selected === realIdx) buttons[i].classList.add('selected');
    }
    if(q.explanation && q.explanation.trim() !== '') { explanationEl.textContent = q.explanation; explanationEl.style.display='block'; } else { explanationEl.style.display='none'; }
    nextBtn.disabled=false; nextBtn.style.display='inline-flex';
  } else {
    explanationEl.style.display='none'; explanationEl.textContent=''; nextBtn.disabled=false; nextBtn.style.display='inline-flex';
  }
  prevBtn.disabled = (current <= 0);
  startQuestionTimer();
}

function handleAnswer(selectedPos, shuffledOrder){
  if(answered) return; answered = true;
  const q = questions[current];
  const actualSelected = (selectedPos>=0) ? shuffledOrder[selectedPos] : -1;
  const buttons = Array.from(optionsEl.children);
  for(let i=0;i<buttons.length;i++){
    const realIdx = shuffledOrder[i];
    buttons[i].disabled = true;
    if(realIdx === q.correct) buttons[i].classList.add('correct');
    if(realIdx === actualSelected && actualSelected !== q.correct) buttons[i].classList.add('wrong');
  }
  if(actualSelected === q.correct) score++;
  history[q.number] = { number: q.number, selected: actualSelected===-1?null:actualSelected, correctIndex: q.correct, correct: actualSelected === q.correct, timeTakenForQuestion: questionElapsedSeconds, shuffledOrder: shuffledOrder };
  if(q.explanation && q.explanation.trim() !== '') { explanationEl.textContent = q.explanation; explanationEl.style.display='block'; } else { explanationEl.style.display='none'; }
  document.getElementById('score').innerText = score;
  document.getElementById('current-question').innerText = current+1;
}

/* Navigation buttons behavior */
prevBtn?.addEventListener('pointerdown', e=>{ e.preventDefault(); prevBtn.classList.add('pressing'); });
prevBtn?.addEventListener('pointerup', e=>{ prevBtn.classList.remove('pressing'); if(current>0){ current--; showQuestion(); } });
prevBtn?.addEventListener('pointerleave', ()=> prevBtn.classList.remove('pressing'));
nextBtn?.addEventListener('pointerdown', e=>{ e.preventDefault(); nextBtn.classList.add('pressing'); });
nextBtn?.addEventListener('pointerup', e=>{
  nextBtn.classList.remove('pressing');
  const q = questions[current];
  if(!history[q.number]) history[q.number] = { number: q.number, selected: null, correctIndex: q.correct, correct: false, timeTakenForQuestion: questionElapsedSeconds, shuffledOrder: history[q.number]?.shuffledOrder || shuffleArray(Array.from({length:q.options.length},(_,i)=>i)) };
  if(current < questions.length - 1){ current++; showQuestion(); } else finishQuiz();
});
nextBtn?.addEventListener('pointerleave', ()=> nextBtn.classList.remove('pressing'));

/* Finish quiz, stats, charts and save */
function finishQuiz(){
  clearAllIntervals(); hideBackdrop('timeup-backdrop'); quizContainer.style.display='none'; scoreContainer.style.display='none'; endScreen.style.display='block';
  const areas = {}, versions = {}, correctByArea = {}, totalByArea = {};
  let answeredCount=0, unansweredCount=0, totalTimeTakenForQuestions=0;

  questions.forEach(q => { const a=q.area||'N/A', v=q.version||'N/A'; if(!areas[a]) areas[a]={correct:0,total:0}; if(!versions[v]) versions[v]={correct:0,total:0}; areas[a].total++; versions[v].total++; totalByArea[a] = (totalByArea[a]||0)+1; });

  Object.values(history).forEach(h => {
    const q = questions.find(x => x.number === h.number); if(!q) return;
    const a = q.area||'N/A', v = q.version||'N/A';
    if(h.correct){ correctByArea[a] = (correctByArea[a]||0)+1; versions[v].correct = (versions[v].correct||0)+1; }
    if(h.selected === null) unansweredCount++; else answeredCount++;
    if(h.timeTakenForQuestion) totalTimeTakenForQuestions += h.timeTakenForQuestion;
  });

  for(const a in areas) areas[a].correct = correctByArea[a]||0;
  const totalCorrect = score;
  const percentOverall = questions.length > 0 ? Math.round(totalCorrect/questions.length*100) : 0;
  performanceSummaryEl.innerHTML = `<div style="font-size:1rem;margin-bottom:10px;"><strong>Puntaje:</strong> ${percentOverall}%<br><strong>Correctas:</strong> ${totalCorrect} de ${questions.length}</div>`;
  resultGeneralEl.style.display = 'block';

  let finalStatsHtml = '<div style="margin-bottom:10px;">';
  finalStatsHtml += `<strong>Preguntas totales:</strong> ${questions.length}<br>`;
  finalStatsHtml += `<strong>Respondidas:</strong> ${answeredCount}<br>`;
  finalStatsHtml += `<strong>Correctas:</strong> ${score}<br>`;
  finalStatsHtml += `<strong>Porcentaje final:</strong> ${percentOverall}%`;
  finalStatsHtml += '</div>';
  finalStatsHtml += '<div style="margin-bottom:6px;"><strong>Tiempos:</strong><br>';
  let tiempoEmpleadostr='N/A', tiempoRestantestr='N/A';
  if(initialTotalSeconds>0){ const tiempoRestante=Math.max(0,totalTimerSeconds); const tiempoEmpleadosec=initialTotalSeconds - tiempoRestante; tiempoEmpleadostr=formatTime(tiempoEmpleadosec); tiempoRestantestr=formatTime(tiempoRestante); }
  else { tiempoEmpleadostr = formatTime(sessionElapsedSeconds); tiempoRestantestr = 'Sin límite'; }
  finalStatsHtml += `<div style="margin-left:10px;"><strong>Tiempo empleado:</strong> ${tiempoEmpleadostr}<br><strong>Tiempo restante:</strong> ${tiempoRestantestr}<br>`;
  const avgTimePerQ = answeredCount>0 ? Math.round((totalTimeTakenForQuestions/answeredCount)) : 0;
  finalStatsHtml += `<strong>Tiempo promedio por pregunta respondida:</strong> ${formatElapsed(avgTimePerQ)}`;
  finalStatsHtml += '</div></div>';

  if(Object.keys(areas).length>0){
    finalStatsHtml += '<div style="margin-top:10px;border-top:1px solid rgba(0,0,0,0.1);padding-top:6px;"><h5>Por áreas:</h5><div style="margin-bottom:6px;"><ul style="margin:3px 0 6px 15px;">';
    for(const a in areas){ const pct = areas[a].total ? Math.round((areas[a].correct/areas[a].total)*100) : 0; finalStatsHtml += `<li>${a}: ${areas[a].correct}/${areas[a].total} (${pct}%)</li>`; }
    finalStatsHtml += '</ul></div></div>';
  }

  finalStatsEl.innerHTML = finalStatsHtml;
  historyListEl.innerHTML = '';
  Object.values(history).forEach(h => { const q = questions.find(x=>x.number===h.number); if(!q) return; const qText = q.question.substring(0,70) + (q.question.length>70?'...':''); const status = h.correct ? 'Correcta' : (h.selected===null ? 'No respondida' : 'Incorrecta'); const t = h.timeTakenForQuestion ? ` - ${h.timeTakenForQuestion}s` : ''; const p = document.createElement('p'); p.textContent = `Pregunta ${q.number}: ${qText} - ${status}${t}`; historyListEl.appendChild(p); });

  if(Object.keys(areas).length>0 || Object.keys(versions).length>0){ groupPerformanceEl.style.display='block'; finalStatsEl.style.display='block'; } else groupPerformanceEl.style.display='none';
  groupHistoryEl.style.display = Object.values(history).length>0 ? 'block' : 'none';

  try { renderCharts(score, questions.length, areas); groupChartsEl.style.display='block'; } catch(e){ console.error('Error al renderizar gráficos:', e); groupChartsEl.style.display='none'; }

  const user = auth.currentUser;
  if(user){
    const results = { percent: percentOverall, total: questions.length, correct: score, timeSpent: sessionElapsedSeconds, areas: areas };
    saveQuizResults(user.uid, results).then(()=>{ loadUserHistory(user.uid); loadProgressData(user.uid); }).catch(console.error);
  }
}

/* Restart & exit handlers */
restartBtn?.addEventListener('click', ()=>{ clearAllIntervals(); history={}; score=0; current=0; answered=false; if(pieChart){ pieChart.destroy(); pieChart = null; } if(barChart){ barChart.destroy(); barChart = null; } groupChartsEl.style.display='none'; groupPerformanceEl.style.display='none'; groupHistoryEl.style.display='none'; resultGeneralEl.style.display='none'; startQuiz(); });
exitNo?.addEventListener('click', ()=> hideBackdrop('exit-backdrop'));
exitYes?.addEventListener('click', ()=> { hideBackdrop('exit-backdrop'); goHome(); });
timeupAccept?.addEventListener('click', ()=> { hideBackdrop('timeup-backdrop'); finishQuiz(); });

/* Charts */
function renderCharts(correctCount, totalCount, areasObj){
  const incorrect = totalCount - correctCount;
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(pieCtx, { type:'pie', data:{ labels:['Correctas','Incorrectas'], datasets:[{ data:[correctCount,incorrect], backgroundColor:[ getComputedStyle(document.documentElement).getPropertyValue('--success').trim() || '#4CAF50', getComputedStyle(document.documentElement).getPropertyValue('--danger').trim() || '#F44336' ] }] }, options:{ plugins:{ legend:{ position:'bottom' } }, responsive:true, maintainAspectRatio:false } });

  const labels = Object.keys(areasObj);
  const data = labels.map(l => { const a = areasObj[l]; return a.total ? Math.round((a.correct/a.total)*100) : 0; });
  const barCtx = document.getElementById('barChart').getContext('2d');
  if(barChart) barChart.destroy();
  barChart = new Chart(barCtx, { type:'bar', data:{ labels, datasets:[{ label:'% exactitud', data, backgroundColor: labels.map(()=> getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#4D89FF') }] }, options:{ indexAxis:'y', scales:{ x:{ beginAtZero:true, max:100 } }, plugins:{ legend:{ display:false } }, responsive:true, maintainAspectRatio:false } });
}

/* Utilities */
function shuffleArray(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
function formatTime(sec){ if(sec===0) return '0m 0s'; if(!sec||sec<=0) return '0m 0s'; const m=Math.floor(sec/60); const s=sec%60; return `${m}m ${s}s`; }
function formatElapsed(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m}m ${s}s`; }

/* goHome: volver al estado inicial */
function goHome(){
  current=0; score=0; history={}; clearAllIntervals();
  if(pieChart){ pieChart.destroy(); pieChart=null; }
  if(barChart){ barChart.destroy(); barChart=null; }
  groupChartsEl.style.display='none'; groupPerformanceEl.style.display='none'; groupHistoryEl.style.display='none'; resultGeneralEl.style.display='none';
  endScreen.style.display='none'; startScreen.style.display='block';
  scoreContainer.style.display='none'; quizContainer.style.display='none';
  totalTimerSeconds=0; initialTotalSeconds=0; sessionElapsedSeconds=0;
  hideBackdrop('progress-backdrop'); hideBackdrop('pmp-tips-backdrop'); hideBackdrop('about-backdrop'); hideBackdrop('home-exit-backdrop');
}

/* ==========================
   Inicialización (al cargar la página)
   ========================== */
async function init(){
  initAuth();
  await loadTipsData();
  onModeChange();
  if(customAllQuestions) customCountInput.disabled = customAllQuestions.checked;
  if(customNoTime) customTimeInput.disabled = customNoTime.checked;
  setupVersionButtons(examVersionButtons,'version-filter-exam');
  setupVersionButtons(customVersionButtons,'custom-version');
  hideBackdrop('exit-backdrop'); hideBackdrop('timeup-backdrop'); hideBackdrop('about-backdrop'); hideBackdrop('pmp-tips-backdrop'); hideBackdrop('progress-backdrop'); hideBackdrop('finish-backdrop'); hideBackdrop('home-exit-backdrop');
  menuDropdown.style.display='none'; isMenuOpen=false; consejosSubmenu.style.display='none'; langMenuList.setAttribute('aria-hidden','true');

  // Cargar preguntas
  startBtn.disabled = true; startBtn.textContent = "Cargando datos...";
  try {
    allQuestions = await cargarPreguntas();
    startBtn.disabled = false; startBtn.textContent = "Comenzar Quiz";
    populateAreas();
  } catch (error) {
    console.error('ERROR cargando datos desde Firestore:', error);
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = 'background:#ffebee;color:#c62828;padding:10px;border-radius:6px;margin-top:10px;text-align:center;';
    errorMsg.innerHTML = `<strong>Error cargando datos</strong><br><small>No se pudieron cargar las preguntas desde Firestore.</small><br><small>Error: ${error.message}</small>`;
    startBtn.parentNode.appendChild(errorMsg);
    startBtn.disabled = true; startBtn.textContent = "Error cargando datos";
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
